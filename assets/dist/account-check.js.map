{"version":3,"sources":["account-check.js"],"names":["System","register","_export","_context","LunaUserAccountChecker","_classCallCheck","instance","Constructor","TypeError","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","key","_createClass","protoProps","staticProps","prototype","_setPrototypeOf","o","p","setPrototypeOf","bind","__proto__","_createSuper","Derived","hasNativeReflectConstruct","Reflect","construct","sham","Proxy","Boolean","valueOf","call","e","_isNativeReflectConstruct","result","Super","_getPrototypeOf","NewTarget","this","constructor","arguments","apply","_possibleConstructorReturn","self","ReferenceError","_assertThisInitialized","getPrototypeOf","setters","_main","execute","obj","value","_Unicorn$mix$with","subClass","superClass","create","_inherits","_super","el","_this","options","undefined","u","defaultsDeep","defaultOptions","dataset","customErrorMessage","__","validate","validate_name","form","closest","registerEvents","setTimeout","registerHandler","account","_this2","trigger","$http","get","route","field","then","res","exists","data","xhr","console","error","_this3","addEventListener","check","accountExists","setCustomValidity","log","validationMessage","fv","module","checkValidity","$validation","getValidation","addValidator","element","r","Unicorn","mix","_class","EventMixin","directive","mounted","_ref","JSON","parse","getBoundedInstance"],"mappings":"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","file":"account-check.js","sourcesContent":["/**\n * Part of earth project.\n *\n * @copyright  Copyright (C) 2022 __ORGANIZATION__.\n * @license    __LICENSE__\n */\n\nimport '@main';\n\nclass LunaUserAccountChecker extends Unicorn.mix(class {}).with(Unicorn.EventMixin) {\n  static defaultOptions = {\n    field: null,\n    validate_name: 'user-account'\n  };\n\n  constructor(el, options = {}) {\n    super();\n\n    this.el = el;\n    this.options = u.defaultsDeep(options, this.constructor.defaultOptions);\n\n    if (!this.el.dataset.customErrorMessage) {\n      this.el.dataset.customErrorMessage = u.__('luna.message.user.account.exists');\n    }\n\n    this.el.dataset.validate = this.el.dataset.validate + '|' + this.options.validate_name;\n    this.form = this.el.closest('form');\n\n    this.registerEvents();\n\n    setTimeout(() => {\n      this.registerHandler();\n    }, 300);\n  }\n\n  check(account) {\n    this.trigger('start', { account });\n\n    return u.$http.get(u.route('@account_check', { field: this.options.field, value: account }))\n      .then((res) => {\n        this.trigger('done', { account, exists: res.data.exists, res });\n\n        return res.data.data.exists;\n      })\n      .catch((xhr) => {\n        console.error(xhr);\n        this.trigger('error', { account, xhr });\n      })\n      .finally(() => {\n        this.trigger('end', { account });\n      });\n  }\n\n  registerEvents() {\n    this.el.addEventListener('change', (e) => {\n      this.check(this.el.value)\n        .then((exists) => {\n          this.el.dataset.accountExists = exists;\n\n          if (!exists) {\n            this.el.setCustomValidity(u.__('luna.message.user.account.exists'));\n            console.log(this.el.validationMessage);\n          } else {\n            this.el.setCustomValidity('');\n          }\n\n          let fv = u.module(this.el, 'field.validation');\n\n          if (!fv) {\n            fv = u.module(this.el.closest('[uni-field-validate]'), 'field.validation');\n          }\n\n          fv.checkValidity();\n        });\n    });\n  }\n\n  getValidation() {\n    return u.$validation.get(this.form);\n  }\n\n  registerHandler() {\n    this.getValidation().addValidator(this.options.validate_name, (value, element) => {\n      const r = element.dataset.accountExists === 'false';\n\n      if (!r) {\n        element.setCustomValidity(u.__('luna.message.user.account.exists'));\n      }\n\n      return r;\n    });\n  }\n}\n\nu.directive('account-check', {\n  mounted(el, { value }) {\n    const options = JSON.parse(value || '{}');\n\n    u.getBoundedInstance(el, 'account.check', (el) => new LunaUserAccountChecker(el, options));\n  }\n});\n"]}