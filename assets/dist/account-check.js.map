{"version":3,"file":"account-check.js","names":["LunaUserAccountChecker","el","options","u","defaultsDeep","constructor","defaultOptions","dataset","customErrorMessage","__","validate","validate_name","form","closest","registerEvents","setTimeout","registerHandler","account","trigger","$http","get","route","field","value","then","res","exists","data","xhr","console","error","addEventListener","e","check","accountExists","setCustomValidity","log","validationMessage","fv","module","checkValidity","$validation","getValidation","addValidator","element","r","Unicorn","mix","EventMixin","directive","mounted","JSON","parse","getBoundedInstance"],"sources":["account-check.js"],"sourcesContent":["/**\n * Part of earth project.\n *\n * @copyright  Copyright (C) 2022 __ORGANIZATION__.\n * @license    __LICENSE__\n */\n\nimport '@main';\n\nclass LunaUserAccountChecker extends Unicorn.mix(class {}).with(Unicorn.EventMixin) {\n  static defaultOptions = {\n    field: null,\n    validate_name: 'user-account'\n  };\n\n  constructor(el, options = {}) {\n    super();\n\n    this.el = el;\n    this.options = u.defaultsDeep(options, this.constructor.defaultOptions);\n\n    if (!this.el.dataset.customErrorMessage) {\n      this.el.dataset.customErrorMessage = u.__('luna.message.user.account.exists');\n    }\n\n    this.el.dataset.validate = this.el.dataset.validate + '|' + this.options.validate_name;\n    this.form = this.el.closest('form');\n\n    this.registerEvents();\n\n    setTimeout(() => {\n      this.registerHandler();\n    }, 300);\n  }\n\n  check(account) {\n    this.trigger('start', { account });\n\n    return u.$http.get(u.route('@account_check', { field: this.options.field, value: account }))\n      .then((res) => {\n        this.trigger('done', { account, exists: res.data.exists, res });\n\n        return res.data.data.exists;\n      })\n      .catch((xhr) => {\n        console.error(xhr);\n        this.trigger('error', { account, xhr });\n      })\n      .finally(() => {\n        this.trigger('end', { account });\n      });\n  }\n\n  registerEvents() {\n    this.el.addEventListener('change', (e) => {\n      this.check(this.el.value)\n        .then((exists) => {\n          this.el.dataset.accountExists = exists;\n\n          if (!exists) {\n            this.el.setCustomValidity(u.__('luna.message.user.account.exists'));\n            console.log(this.el.validationMessage);\n          } else {\n            this.el.setCustomValidity('');\n          }\n\n          let fv = u.module(this.el, 'field.validation');\n\n          if (!fv) {\n            fv = u.module(this.el.closest('[uni-field-validate]'), 'field.validation');\n          }\n\n          fv.checkValidity();\n        });\n    });\n  }\n\n  getValidation() {\n    return u.$validation.get(this.form);\n  }\n\n  registerHandler() {\n    this.getValidation().addValidator(this.options.validate_name, (value, element) => {\n      const r = element.dataset.accountExists === 'false';\n\n      if (!r) {\n        element.setCustomValidity(u.__('luna.message.user.account.exists'));\n      }\n\n      return r;\n    });\n  }\n}\n\nu.directive('account-check', {\n  mounted(el, { value }) {\n    const options = JSON.parse(value || '{}');\n\n    u.getBoundedInstance(el, 'account.check', (el) => new LunaUserAccountChecker(el, options));\n  }\n});\n"],"mappings":"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"}